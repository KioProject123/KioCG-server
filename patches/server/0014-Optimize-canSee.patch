From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Joket_abc <15005771700@qq.com>
Date: Fri, 16 Jun 2023 05:29:40 +0800
Subject: [PATCH] Optimize canSee


diff --git a/src/main/java/net/minecraft/server/level/ChunkMap.java b/src/main/java/net/minecraft/server/level/ChunkMap.java
index 906b5b69eec30146e117b7d791e0376fba3e2cae..eb7ecae44e52a36d41eb158172db58dbfabeef43 100644
--- a/src/main/java/net/minecraft/server/level/ChunkMap.java
+++ b/src/main/java/net/minecraft/server/level/ChunkMap.java
@@ -1537,6 +1537,7 @@ public class ChunkMap extends ChunkStorage implements ChunkHolder.PlayerProvider
                 boolean flag = d1 <= d2 && this.entity.broadcastToPlayer(player);
 
                 // CraftBukkit start - respect vanish API
+                if (flag) // KioCG
                 if (!player.getBukkitEntity().canSee(this.entity.getBukkitEntity())) {
                     flag = false;
                 }
diff --git a/src/main/java/org/bukkit/craftbukkit/entity/CraftEntity.java b/src/main/java/org/bukkit/craftbukkit/entity/CraftEntity.java
index 2381360aa8543fefdc7f205a199799f177840c3d..c00eff4e1280b6ff79df95f84ef74c9f1daba96e 100644
--- a/src/main/java/org/bukkit/craftbukkit/entity/CraftEntity.java
+++ b/src/main/java/org/bukkit/craftbukkit/entity/CraftEntity.java
@@ -1027,6 +1027,7 @@ public abstract class CraftEntity implements org.bukkit.entity.Entity {
 
     @Override
     public void setVisibleByDefault(boolean visible) {
+        if (!(this instanceof CraftPlayer)) throw new UnsupportedOperationException("Not supported yet. (KioCG optimize)"); // KioCG
         if (this.getHandle().visibleByDefault != visible) {
             if (visible) {
                 // Making visible by default, reset and show to all players
diff --git a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
index 8f7d6be9634f115159a216f818f12060244e70e2..12a8abfc4d65ee0fda16972e802bb7024a7780da 100644
--- a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
+++ b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
@@ -1840,6 +1840,7 @@ public class CraftPlayer extends CraftHumanEntity implements Player {
 
     @Override
     public void hideEntity(Plugin plugin, org.bukkit.entity.Entity entity) {
+        if (!(entity instanceof Player)) throw new UnsupportedOperationException("Not supported yet. (KioCG optimize)"); // KioCG
         Preconditions.checkArgument(plugin != null, "Plugin cannot be null");
         Preconditions.checkArgument(plugin.isEnabled(), "Plugin (%s) cannot be disabled", plugin.getName());
 
@@ -1927,6 +1928,7 @@ public class CraftPlayer extends CraftHumanEntity implements Player {
 
     @Override
     public void showEntity(Plugin plugin, org.bukkit.entity.Entity entity) {
+        if (!(entity instanceof Player)) throw new UnsupportedOperationException("Not supported yet. (KioCG optimize)"); // KioCG
         Preconditions.checkArgument(plugin != null, "Plugin cannot be null");
         // Don't require that plugin be enabled. A plugin must be allowed to call
         // showPlayer during its onDisable() method.
@@ -2079,7 +2081,8 @@ public class CraftPlayer extends CraftHumanEntity implements Player {
 
     @Override
     public boolean canSee(org.bukkit.entity.Entity entity) {
-        return this.equals(entity) || entity.isVisibleByDefault() ^ this.invertedVisibilityEntities.containsKey(entity.getUniqueId()); // SPIGOT-7312: Can always see self
+        if (!(entity instanceof Player)) return true; // KioCG
+        return this.equals(entity) || entity.isVisibleByDefault() ^ (!this.invertedVisibilityEntities.isEmpty() && this.invertedVisibilityEntities.containsKey(entity.getUniqueId())); // SPIGOT-7312: Can always see self // KioCG
     }
 
     public boolean canSee(UUID uuid) {
